<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{{ titre }}</title>
        <script type="text/javascript" src="{{url_for('static', filename='d3/d3.v3.js')}}"></script>
        <link href="{{ url_for('static', filename='css/surfcheck.css') }}" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="container">
            <div class="page-header">
                <h1>Surfcheck!</h1>
            </div>

                <div id="wave-height" class="row">
                    <div class="col-md-8" id="chart-wave-height">
                        <svg viewBox="0 0 700 200" preserveAspectRatio="xMidYMid meet"></svg>
                    </div>
                    <div class="col-md-4" id="ind-wave-height">
                    </div>
                </div>
        </div>

        <script type="text/javascript">
            

            // var api = "http://92.89.90.56:5001/surfchecks";
            var api = "http://localhost:5001/surfchecks";


            d3.json(api, function (json_data) {
                var width=700;
                var height=200;
                var data = json_data.wave_data;
                var minDate =  new Date(data[0].datetime),
                    maxDate = new Date(data[data.length-1].datetime);
                // Largeur et hauteur

                var svg = d3.select("svg");
                var chart_margin = {top: 0, right: 0, bottom: 0, left: 0};
                var chart_weight = width - chart_margin.left - chart_margin.right
                var chart_height = height - chart_margin.top - chart_margin.bottom;
                var barPadding = 1; 

                // Parse the date / time
                // var parseDate = d3.time.format("%Y-%m-%dT%H:%M:%S.%LZ").parse;

                // scale
                var whScale = d3.scale.linear()
                        .domain([0, 3])
                        .range([chart_height, 0]);
                var dtScale = d3.time.scale().domain([minDate, maxDate]).range([0, chart_weight]);

                // axis
                var yAxis = d3.svg.axis()
                  .scale(whScale)
                  .orient("left");
                var xAxis = d3.svg.axis()
                    .scale(dtScale)
                    .orient("bottom")
                    .tickFormat(d3.time.format("%d-%m %H:%M"));

                // chart and axis group
                var chart = svg.append("g")
                    .attr("class", "chart")
                    .attr("transform", "translate(" + chart_margin.left + "," + chart_margin.top + ")");

                // chart
                chart.append("g")
                    .selectAll("rect")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", function(d, i) {
                        if(i == data.length - 1) {
                            return "bar active";
                        }
                        return "bar";
                    })
                    .attr("data-wave_height", function(d) {return d.wave_height})
                    // .attr("fill", "teal")
                    // .attr("fill", function(d) {
                    //     return "rgb(" + (255 - Math.round(d.wave_period * 17)) + ", 0, 0)"; //15s = 255
                    // })
                    .attr("x", 0)
                    .attr("y", function(d) {
                        return whScale(d.wave_height);
                    })
                    .attr("width", chart_weight / data.length - barPadding)
                    .attr("height", function(d) {
                        return chart_height - whScale(d.wave_height);
                    })
                    .attr("x", function(d, i) {
                        return i * (chart_weight / data.length);
                    });

                // // Y axis
                // chart.append("g")
                //     .attr("class", "y axis")
                //     .call(yAxis);
                // // X axis
                // chart.append("g")
                //     .attr("class", "x axis")
                //     .attr("transform", "translate(0," + chart_height + ")")
                //     .call(xAxis)

                // indicators
                d3.select("#ind-wave-height")
                    .data(data)
                    .enter()
                    .append("div")
                    .attr("class", function(d, i) {
                        if(i == data.length - 1) {
                            return "indicator-text";
                        }
                        return "indicator-text invisible";
                    })
                    .text(function(d) { 
                        return d.wave_height + 'm'; 
                    });
            })
        </script>

{# 
        {% for doc in docs %}
        <ul>
             {% for key, value in doc.items() %}
                <li>{{key}} : {{value}}</li>
            {% endfor %}
        </ul>
        {% endfor %}
 #}
    </body>
</html>
